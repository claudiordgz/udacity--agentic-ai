<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Helius System Design – Mermaid Diagrams (Fixed)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; line-height: 1.45; }
    h1 { margin-bottom: 0.25rem; }
    h2 { margin-top: 2rem; }
    .diagram { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-top: 12px; background: #fafafa; }
    .tip { color: #6b7280; font-size: 0.9rem; }
    code { background:#f3f4f6; padding:2px 4px; border-radius:6px; }
  </style>
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true, theme: "default" });
  </script>
</head>
<body>
  <h1>Helius System Design – Mermaid Diagrams</h1>
  <p class="tip">Open this file in a modern browser with internet access to render the diagrams.</p>

  <!-- 1) Scalable RPC / Query Service for Solana -->
  <h2>1) Scalable RPC / Query Service for Solana</h2>
  <div class="diagram mermaid">
flowchart TD
  C[Clients] --> GW[API Gateway / Auth / Quotas / Rate Limit]
  subgraph Edge
    GW --> RL[Rate Limiter]
    RL --> CAC[Hot Key Cache (Redis/Memcached)]
  end
  CAC -- cache hit --> RESP1[JSON Response]
  CAC -- miss --> QD[Query Dispatcher]
  subgraph RPC_Fleet
    QD --> W1[RPC Worker A (Sim/History)]
    QD --> W2[RPC Worker B]
    QD --> W3[RPC Worker C]
  end
  subgraph Solana
    W1 --> SN1[Solana Node / Archive]
    W2 --> SN2[Solana Node / Archive]
    W3 --> SN3[Solana Node / Archive]
  end
  subgraph Subscriptions
    GW -. subscribe .-> PS[Pub/Sub Topics (Accounts/Programs)]
    PS --> SB[Subscription Broker]
    SB --> CAC
  end
  W1 --> CAC
  W2 --> CAC
  W3 --> CAC
  RESP1 --> C
  </div>

  <!-- 2) Transaction Forwarding Pipeline -->
  <h2>2) Transaction Forwarding Pipeline (Gulf Stream style)</h2>
  <div class="diagram mermaid">
flowchart LR
  U[Clients / SDKs] --> EP[Tx Ingest Endpoint (Auth / QoS / Anti-DoS)]
  EP --> VAL[Stateless Validation (sigs / basic rules)]
  VAL --> PRIO[Priority Router (stake / QoS tiers)]
  PRIO --> QH[High-Priority Queue]
  PRIO --> QN[Normal Queue]
  PRIO --> QL[Low-Priority Queue]
  subgraph Forwarders
    FW1[Forwarder A] --> LDR[Current / Upcoming Leaders]
    FW2[Forwarder B] --> VALS[Validators (fallback)]
  end
  QH --> FW1
  QN --> FW1
  QL --> FW2
  FW1 -. retry/backoff .-> FW2
  FW1 --> REP[Replication Fanout]
  REP --> LDR
  </div>

  <!-- 3) Webhook / Event Streaming -->
  <h2>3) Webhook / Event Streaming System</h2>
  <div class="diagram mermaid">
flowchart TD
  SRC[On-chain Events / Geyser / Indexer] --> ENR[Enricher (decode tx, add metadata)]
  ENR --> OQ[Ordered Event Log (Kafka/Pulsar)]
  OQ --> DLQ[Dead Letter Queue]
  OQ --> DEMUX[Topic Demux (account/program filter)]
  DEMUX --> WS[WebSocket Hub]
  DEMUX --> WH[Webhook Dispatcher]
  subgraph Delivery
    WH --> RETRY[Retry / Backoff / Idempotency]
    WS --> CRS[Fan-out to Subscribers]
    RETRY --> SUBS[(Customer Endpoints)]
    CRS --> SUBS
  end
  SUBS -. acks / metrics .-> WH
  </div>

  <!-- 4) Multi-tenant Isolation -->
  <h2>4) Multi-tenant Isolation for Shared RPC</h2>
  <div class="diagram mermaid">
flowchart LR
  C1[Tenant A Clients] --> G[API Gateway]
  C2[Tenant B Clients] --> G
  C3[Tenant C Clients] --> G
  G --> AUTH[AuthN/Z + Token Scopes]
  AUTH --> QOS[Per-Tenant Quotas & Rate Limits]
  QOS --> SCHED[Fair Scheduler (WFQ/DRR)]
  SCHED --> P1[Pool A (Isolated)]
  SCHED --> P2[Pool B (Isolated)]
  SCHED --> P3[Pool C (Burst)]
  subgraph Metrics
    P1 --> OBS[Observability (SLIs/SLOs per tenant)]
    P2 --> OBS
    P3 --> OBS
  end
  OBS --> CTRL[Auto-Scaler + Circuit Breakers]
  CTRL --> P1
  CTRL --> P2
  CTRL --> P3
  </div>

  <!-- 5) Data Ingestion + Compression + Storage -->
  <h2>5) Data Ingestion + Compression + Storage</h2>
  <div class="diagram mermaid">
flowchart TD
  SRC[Chain Logs / Account Changes / Tx Meta] --> BUF[Ingest Buffer (Kafka/Pulsar)]
  BUF --> NORM[Normalizer (schema, dedup, ordering)]
  NORM --> COMP[Compressor (delta + columnar)]
  COMP --> HOT[Hot Store (Row/Doc DB) - low latency]
  COMP --> COLD[Cold Store (S3/Lake) - Parquet/ZSTD]
  HOT --> IDX[Secondary Indexer (accounts/programs/time)]
  COLD --> IDX
  IDX --> QRY[Query Service (filters, range scans)]
  QRY --> API[Developer API]
  </div>

  <!-- 6) Fallback / Resilience -->
  <h2>6) Fallback / Resilience & Degradation</h2>
  <div class="diagram mermaid">
flowchart LR
  CL[Clients] --> AG[Edge / API Gateway]
  AG --> CB[Circuit Breaker (per backend/region)]
  CB --> P0[Primary Cluster]
  CB --> P1[Secondary Cluster]
  P0 --> H[Health / Heartbeats]
  P1 --> H
  H --> CB
  subgraph Degradation_Modes
    DG1[Read from cache only]
    DG2[Limit write / simulate endpoints]
    DG3[Queue and drain later]
  end
  CB -. on failure .-> DG1
  CB -. overload .-> DG2
  CB -. partial outage .-> DG3
  AG --> WAF[DDoS / WAF / Bot Shield]
  WAF --> CL
  </div>

  <!-- 7) Developer Console API Layer -->
  <h2>7) Developer Console API Layer</h2>
  <div class="diagram mermaid">
flowchart TD
  DEV[Developers / Console UI] --> API[Console API Gateway (Auth / Scopes)]
  API --> DEC[Tx Decoder (ABI/program-aware)]
  API --> ENR[Enrichment (entity links, tags)]
  API --> FLT[Filter Engine (account/program/time)]
  API --> QRY[Query Orchestrator]
  subgraph Data_Plane
    QRY --> HOT[Hot Store (txn/account state)]
    QRY --> IDX[Search / Index (inverted/columnar)]
    QRY --> HIST[Historical Lake (Parquet)]
  end
  ENR --> OUT[JSON/CSV Exports + Webhooks]
  DEC --> OUT
  FLT --> OUT
  OUT --> DEV
  </div>
</body>
</html>